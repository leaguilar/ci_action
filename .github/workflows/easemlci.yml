name: Easeml/CI
on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - 'master'
      - 'feature/cicd'
  create:
    tags:
      - 'v*'
env:
    CI: true
    TERM: xterm
jobs:
    easeml_ci:
        runs-on: ubuntu-latest
        steps:
            - name: Install Prerequisites
              run: |
                echo "Initializing the software prerequisites"
                sudo apt update
                sudo apt install -y build-essential python3-dev libssl-dev libffi-dev
                sudo apt install -y ca-certificates curl gnupg lsb-release
                echo "Installing docker"
                echo "Adding docker gpg key"
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                echo "Setting the correct docker repository"
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                echo "Updating APT"
                sudo apt update
                echo "Installing Docker engine"
                sudo apt install -y docker-ce docker-ce-cli containerd.io
                echo "Testing Docker"
                sudo docker run hello-world
                echo "Enabling non sudo use of docker"
                sudo usermod -aG docker $USER
                newgrp docker
                
                echo "Installing Easeml/CI" 
                pip install git+https://github.com/easeml/ci.git@feature/actions
                
                echo "Adding decryption and encryption keys"
                mkdir -p $HOME/.easeml/keys
                echo $EASEML_PRIV_FILE > $HOME/.easeml/keys/easeml_priv.asc
                echo $EASEML_PUB_FILE > $HOME/.easeml/keys/easeml_pub.asc
              env:
                EASEML_PRIV_FILE : ${{secrets.EASEML_PRIV}}
                EASEML_PUB_FILE : ${{secrets.EASEML_PUB}}
            - name: Check out code
              uses: actions/checkout@v1
            - name: Test
              run: |
                easeml_cicd_runner ${GITHUB_ACTOR} ${GITHUB_TOKEN} ${GITHUB_REPOSITORY} ${GITHUB_SHA} ${GITHUB_REF_NAME} -g

